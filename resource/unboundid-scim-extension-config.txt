# Copyright 2011 UnboundID Corp.
# All Rights Reserved.
#

# This file provides commands to configure the UnboundID Directory Server to run
# the SCIM plugin extension. This file may be used as a dsconfig batch file.
#
# The general steps to configure the the Directory Server to run the SCIM
# plugin extension are as follows:
#
# 1. Copy the extension jar and all its dependencies to lib/extensions/
# 2. Copy the SCIM schema xsd files to resource/schema/
# 3. Restart the server so that the jars get loaded.
# 4. Create the plugin configuration.
# 5. Create some Virtual List View indexes to support pagination.
# 6. Stop the server.
# 6. Build the Virtual List View indexes.
# 7. Start the server.
# 8. Configure desired Access Control.


#
# Create the plugin configuration (change the baseDN and port as desired).
#

dsconfig create-plugin --plugin-name "SCIM Plugin" --type third-party \
  --set enabled:true --set plugin-type:startup \
  --set extension-class:com.unboundid.scim.ldap.SCIMPlugin \
  --set extension-argument:useSchemaFile=resource/schema \
  --set extension-argument:port=8080 \
  --set extension-argument:baseDN=dc=example,dc=com

#
# Create some Virtual List View indexes to support pagination.
#

dsconfig create-local-db-vlv-index --backend-name userRoot \
  --index-name ascending-uid --set base-dn:dc=example,dc=com \
  --set scope:whole-subtree --set "filter:(objectclass=inetorgperson)" \
  --set "sort-order:+uid"

dsconfig create-local-db-vlv-index --backend-name userRoot \
  --index-name ascending-sn --set base-dn:dc=example,dc=com \
  --set scope:whole-subtree --set "filter:(objectclass=inetorgperson)" \
  --set "sort-order:+sn"

#
# Command to build the Virtual List View indexes created earlier:
# rebuild-index --baseDN dc=example,dc=com \
#   --index vlv.ascending-uid --index vlv.ascending-sn
#

#
# Add Access Control for demo purposes to allow write access for all
# authenticated users.
#

dsconfig set-access-control-handler-prop \
  --add 'global-aci:(targetattr="*")(version 3.0; acl \
  "Grant full access for any authenticated user"; \
  allow (all) userdn="ldap:///all";)'

dsconfig set-access-control-handler-prop \
  --add 'global-aci:(targetcontrol="1.3.6.1.1.13.2 || 1.2.840.113556.1.4.473 ||\
  2.16.840.1.113730.3.4.9")(version 3.0;acl \
  "Authenticated access to controls used by the SCIM plugin"; \
  allow (all) userdn="ldap:///all";)'
